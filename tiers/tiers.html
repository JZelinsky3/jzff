<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, user-scalable=yes" />
  <title>JZ Fantasy Football - Player Tiers</title>
  <link rel="stylesheet" href="tiers.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
</head>
<body>
  <div id="scale-wrapper">
    <header class="header">
      <div class="nav-left">
        <a href="../index.html" class="nav-link">Home</a>
        <a href="../averages/averages.html" class="nav-link role-admin-only" style="display: none;">Rankings</a>
        <a href="../draft/draft.html" class="nav-link role-admin-only" style="display: none;">Draft</a>
      </div>
      <h1 class="header-title">Tiers</h1>
      <div class="nav-right dropdown role-admin-only" style="display: none;">
        <button class="dropbtn">Positions â–¾</button>
        <div class="dropdown-content">
          <a href="../positions/qbs.html">QBs</a>
          <a href="../positions/rbs.html">RBs</a>
          <a href="../positions/wrs.html">WRs</a>
          <a href="../positions/tes.html">TEs</a>
        </div>
      </div>
    </header>

    <main class="main-container">
      <section class="player-list">
        <h1>Player List</h1>
        <ul id="players"></ul>
      </section>
      <section id="tier-container" class="tier-container"></section>
    </main>

    <div id="toast"></div>

    <!-- Guest Modal -->
    <div id="guest-modal" class="modal hidden">
      <div class="modal-content">
        <span class="modal-close" id="modal-close">&times;</span>
        <p>You need an account to save your tiers.<br />Would you like to sign in or register?</p>
        <div class="modal-actions">
          <button id="modal-register" class="btn save-btn">Register</button>
          <button id="modal-login" class="btn clear-btn">Login</button>
        </div>
      </div>
    </div>

    <div id="button-container">
      <button id="saveBtn" class="btn save-btn">Save</button>
      <button id="clearBtn" class="btn clear-btn">Clear</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAUk7lfFezJ-pL_-MaDSIoL5RzogPnJw4c",
      authDomain: "ffootball-1ffa4.firebaseapp.com",
      projectId: "ffootball-1ffa4",
      storageBucket: "ffootball-1ffa4.appspot.com",
      messagingSenderId: "214820317243",
      appId: "1:214820317243:web:00907255d3ee230f21541e",
      measurementId: "G-H9LQY4GWSN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();

    const playersList = document.getElementById("players");
    const tierContainer = document.getElementById("tier-container");
    const saveBtn = document.getElementById("saveBtn");
    const clearBtn = document.getElementById("clearBtn");
    const toast = document.getElementById("toast");
    const modal = document.getElementById("guest-modal");
    const modalLogin = document.getElementById("modal-login");
    const modalRegister = document.getElementById("modal-register");
    const modalClose = document.getElementById("modal-close");

    const NUM_TIERS = 10;
    let currentUser = null;

    function createTiers() {
      for (let i = 1; i <= NUM_TIERS; i++) {
        const tierDiv = document.createElement("div");
        tierDiv.className = "tier-column";
        tierDiv.dataset.tier = i;
        tierDiv.innerHTML = `<h2>Tier ${i}</h2><ul class="dropzone"></ul>`;
        const dropzone = tierDiv.querySelector(".dropzone");

        dropzone.addEventListener("dragover", e => e.preventDefault());
        dropzone.addEventListener("drop", e => {
          e.preventDefault();
          const id = e.dataTransfer.getData("text/plain");
          const draggedEl = document.getElementById(id);
          if (draggedEl && dropzone !== draggedEl.parentElement) {
            dropzone.appendChild(draggedEl);
          }
        });

        tierContainer.appendChild(tierDiv);
      }
    }

    async function loadPlayers(role = "guest") {
      const jsonFile = (role === "admin" || role === "master") ? "tiers.json" : "basic.json";
      const showAdp = (role === "admin" || role === "master");

      try {
        const res = await fetch(jsonFile);
        const data = await res.json();

        data.forEach(player => {
          const li = document.createElement("li");
          li.textContent = showAdp
            ? `${player.name} (${player.position}, ADP: ${player.adp})`
            : `${player.name} (${player.position})`;
          li.id = `player-${player.id || player.name.replace(/\s+/g, "-").toLowerCase()}`;
          li.className = "player-item";
          li.draggable = true;

          li.addEventListener("dragstart", e => {
            e.dataTransfer.setData("text/plain", li.id);
          });

          playersList.appendChild(li);
        });
      } catch (err) {
        showToast("Error loading players: " + err.message);
      }
    }

    async function saveTiers(uid) {
      const result = {};
      const tiers = document.querySelectorAll(".tier-column");

      tiers.forEach(tier => {
        const tierNum = tier.dataset.tier;
        const players = Array.from(tier.querySelectorAll(".dropzone > li"))
          .map(li => li.textContent);
        result[`Tier_${tierNum}`] = players;
      });

      try {
        await setDoc(doc(db, "tiers", uid), result);
        showToast("Tiers saved!");
      } catch (err) {
        showToast("Error saving tiers: " + err.message);
      }
    }

    async function loadSavedTiers(uid) {
      try {
        const docSnap = await getDoc(doc(db, "tiers", uid));
        if (docSnap.exists()) {
          const savedData = docSnap.data();
          for (const [tierKey, playerList] of Object.entries(savedData)) {
            const tierNum = tierKey.split("_")[1];
            const dropzone = document.querySelector(`.tier-column[data-tier='${tierNum}'] .dropzone`);

            playerList.forEach(text => {
              const allPlayers = document.querySelectorAll("#players li, .tier-column .dropzone > li");
              const match = Array.from(allPlayers).find(li => li.textContent === text);
              if (match) dropzone.appendChild(match);
            });
          }
        }
      } catch (err) {
        showToast("Error loading saved tiers: " + err.message);
      }
    }

    async function clearTiers(uid) {
      const tierPlayers = document.querySelectorAll(".tier-column .dropzone > li");
      tierPlayers.forEach(player => {
        playersList.appendChild(player);
      });

      try {
        if (uid) {
          await setDoc(doc(db, "tiers", uid), {});
        }
        showToast("Tiers cleared!");
      } catch (err) {
        showToast("Error clearing tiers: " + err.message);
      }
    }

    function showToast(message) {
      toast.textContent = message;
      toast.style.visibility = "visible";
      toast.style.opacity = "1";
      setTimeout(() => {
        toast.style.opacity = "0";
        toast.style.visibility = "hidden";
      }, 3000);
    }

    function showModal() {
      modal.classList.remove("hidden");
    }

    function hideModal() {
      modal.classList.add("hidden");
    }

    onAuthStateChanged(auth, async user => {
      createTiers();

      let role = "guest";
      currentUser = user;

      if (user) {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        role = userDoc.exists() ? userDoc.data().role : "guest";

        if (role === "admin" || role === "master") {
          document.querySelectorAll(".role-admin-only").forEach(el => {
            el.style.display = "flex";
          });
        }

        await loadPlayers(role);
        await loadSavedTiers(user.uid);
      } else {
        await loadPlayers(role);
      }
    });

    saveBtn.addEventListener("click", () => {
      if (!currentUser) {
        showModal();
        return;
      }
      saveTiers(currentUser.uid);
    });

    clearBtn.addEventListener("click", () => {
      const uid = currentUser?.uid || null;
      clearTiers(uid);
    });

    modalRegister.addEventListener("click", () => {
      window.location.href = "../account/register.html";
    });

    modalLogin.addEventListener("click", () => {
      window.location.href = "../account/login.html";
    });

    modalClose.addEventListener("click", hideModal);
  </script>
</body>
</html>
