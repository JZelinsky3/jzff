<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Power Rankings — League Consensus</title>
  <link rel="stylesheet" href="/league.css">
  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;margin:0;background:#f6f7fb;color:#0b1220}
    .container{max-width:1000px;margin:28px auto;padding:18px;background:#fff;border-radius:12px;box-shadow:0 6px 20px rgba(11,18,32,.06)}
    h1{margin:0 0 12px;font-size:22px}
    .summary{display:flex;gap:12px;align-items:center;justify-content:space-between}
    table{width:100%;border-collapse:collapse;margin-top:18px}
    th,td{padding:10px;border-bottom:1px solid #eef1fa;text-align:left}
    th{background:#fbfcff}
    .leader{display:flex;gap:12px;align-items:center}
    .leader img{width:40px;height:40px;border-radius:8px}
    .small{font-size:13px;color:#5b6b8a}

    .podium-large{display:flex;gap:20px;justify-content:center;align-items:flex-end;margin-top:12px}
    .podium-large .slot{padding:12px;border-radius:10px;text-align:center;display:flex;flex-direction:column;align-items:center}
    .podium-large .first{width:260px;background:linear-gradient(180deg,#ffd966,#ffb700);}
    .podium-large .second{width:180px;background:linear-gradient(180deg,#dfe8f8,#9fb7ff);transform:scale(0.96)}
    .podium-large .third{width:160px;background:linear-gradient(180deg,#f2e6d5,#e1b78a);}

    /* MOBILE ADJUSTMENTS */
    @media (max-width:720px) {
      .container { margin: 16px auto; padding: 14px; }
      .summary { flex-direction: column; align-items: flex-start; gap: 8px; }
      .summary .small { order: 1; }
      .summary > div:last-child { order: 2; }

      /* force podium into a single small row that fits */
      .podium-large {
        flex-wrap: nowrap;
        justify-content: space-between;
        gap: 10px;
        margin-top: 10px;
      }
      .podium-large .slot { flex: 1 1 0; min-width: 0; padding: 8px; border-radius:8px; }
      .podium-large .first { width: auto; padding: 10px; }
      .podium-large .second, .podium-large .third { padding: 8px; transform: scale(0.94); }

      /* shrink images */
      .podium-large img { display:block; }
      .podium-large .first img { width: 84px; height: 84px; border-radius:10px; }
      .podium-large .second img, .podium-large .third img { width: 64px; height: 64px; border-radius:8px; }

      /* table tweaks for narrow screens */
      th, td { padding: 8px; font-size: 14px; }
      .leader img { width:34px; height:34px; }
    }

    @media (max-width:420px) {
      .podium-large .first img { width:72px; height:72px; }
      .podium-large .second img, .podium-large .third img { width:56px; height:56px; }
      th, td { padding: 7px; font-size: 13px; }
      h1 { font-size: 20px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>League Consensus — Power Rankings</h1>
    <div class="summary">
      <div class="small">This page averages all submitted rankings from the <code>powerRankings</code> collection. Teams with no votes show <em>—</em>. Logos are pulled from <code>../pickems/teams.json</code>.</div>
      <div><button id="refreshBtn" class="btn">Refresh</button></div>
    </div>

    <div id="podiumArea" style="margin-top:18px"></div>

    <table id="rankTable" aria-describedby="rankings">
      <thead>
        <tr><th style="width:64px">#</th><th>Team</th><th style="width:120px">Avg Rank</th><th style="width:80px">Votes</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAUk7lfFezJ-pL_-MaDSIoL5RzogPnJw4c",
      authDomain: "ffootball-1ffa4.firebaseapp.com",
      projectId: "ffootball-1ffa4",
      storageBucket: "ffootball-1ffa4.appspot.com",
      messagingSenderId: "214820317243",
      appId: "1:214820317243:web:00907255d3ee230f21541e",
      measurementId: "G-H9LQY4GWSN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const refreshBtn = document.getElementById('refreshBtn');
    refreshBtn.addEventListener('click', loadConsensus);

    async function loadTeams(){
      try{ const resp = await fetch('teams_w08.json'); const json = await resp.json(); return json.teams || []; }
      catch(e){ console.warn('teams.json missing'); return []; }
    }

    function formatAvg(a){ return a===null ? '—' : (Math.round(a*100)/100).toFixed(2); }

    async function loadConsensus(){
      const teams = await loadTeams();
      const masterIds = teams.map(t=>t.id);

      // build lookup for names and logos
      const teamLookup = teams.reduce((acc,t)=>{ acc[t.id]={name:t.name, logo:t.logo, manager:t.manager, record:t.record}; return acc; },{});

      // init score arrays
      const votes = {}; masterIds.forEach(id=>votes[id]=[]);

      const snap = await getDocs(collection(db,'powerRankings'));
      snap.forEach(ds=>{
        const d = ds.data();
        if(!d || !Array.isArray(d.rankings) || d.rankings.length===0) return;
        d.rankings.forEach((teamId, idx)=>{
          if(!votes[teamId]) votes[teamId]=[];
          votes[teamId].push(idx+1);
        });
      });

      const tableBody = document.querySelector('#rankTable tbody'); tableBody.innerHTML='';
      const rows = Object.entries(votes).map(([teamId, arr])=>{
        const avg = arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : null;
        return { teamId, avg, votes: arr.length };
      });

      // sort: lower avg first, nulls to bottom (and show votes desc for ties)
      rows.sort((a,b)=>{ if(a.avg===null && b.avg===null) return b.votes - a.votes; if(a.avg===null) return 1; if(b.avg===null) return -1; if(a.avg===b.avg) return b.votes - a.votes; return a.avg - b.avg; });

      // podium area
      const podiumArea = document.getElementById('podiumArea');
      const [first, second, third] = rows.slice(0,3);
      const firstLogo = first && teamLookup[first.teamId] && teamLookup[first.teamId].logo ? teamLookup[first.teamId].logo : '/league/assets/logos/default.png';
      const secondLogo = second && teamLookup[second.teamId] && teamLookup[second.teamId].logo ? teamLookup[second.teamId].logo : '/league/assets/logos/default.png';
      const thirdLogo = third && teamLookup[third.teamId] && teamLookup[third.teamId].logo ? teamLookup[third.teamId].logo : '/league/assets/logos/default.png';

      podiumArea.innerHTML = `
        <div class="podium-large">
          <div class="slot second">
            <div style="padding:10px">
              <img src="${secondLogo}" onerror="this.src='/league/assets/logos/default.png'" style="width:80px;height:80px;border-radius:10px">
              <div style="margin-top:8px">${second?escapeHtml(teamLookup[second.teamId].name): '—'}</div>
              <div class="small">Votes: ${second?second.votes:0} Avg: ${second?formatAvg(second.avg):'—'}</div>
            </div>
          </div>

          <div class="slot first">
            <div style="padding:12px">
              <img src="${firstLogo}" onerror="this.src='/league/assets/logos/default.png'" style="width:120px;height:120px;border-radius:12px">
              <div style="margin-top:8px;font-weight:700">${first?escapeHtml(teamLookup[first.teamId].name):'—'}</div>
              <div class="small">Votes: ${first?first.votes:0} Avg: ${first?formatAvg(first.avg):'—'}</div>
            </div>
          </div>

          <div class="slot third">
            <div style="padding:10px">
              <img src="${thirdLogo}" onerror="this.src='/league/assets/logos/default.png'" style="width:80px;height:80px;border-radius:10px">
              <div style="margin-top:8px">${third?escapeHtml(teamLookup[third.teamId].name):'—'}</div>
              <div class="small">Votes: ${third?third.votes:0} Avg: ${third?formatAvg(third.avg):'—'}</div>
            </div>
          </div>
        </div>
      `;

      // table rows
      rows.forEach((r, i)=>{
        const logo = teamLookup[r.teamId] && teamLookup[r.teamId].logo ? teamLookup[r.teamId].logo : '/league/assets/logos/default.png';
        const name = teamLookup[r.teamId] && teamLookup[r.teamId].name ? teamLookup[r.teamId].name : r.teamId;
        const manager = teamLookup[r.teamId] && teamLookup[r.teamId].manager ? teamLookup[r.teamId].manager : '';
        const record = teamLookup[r.teamId] && teamLookup[r.teamId].record ? teamLookup[r.teamId].record : '';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="width:60px">${i+1}</td>
          <td>
            <div class="leader">
              <img src="${logo}" onerror="this.src='/league/assets/logos/default.png'">
              <div>
                <div style="font-weight:700">${escapeHtml(name)}</div>
                <div class="small">${ escapeHtml(manager || r.teamId) }${ record ? ` • ${escapeHtml(record)}` : '' }</div>
              </div>
            </div>
          </td>
          <td>${formatAvg(r.avg)}</td>
          <td>${r.votes}</td>
        `;
        tableBody.appendChild(tr);
      });
    }

    function escapeHtml(s){return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');}

    // initial
    loadConsensus();
  </script>
</body>
</html>
